import{r as c,o as U,p as q,q as x,t as k}from"./index-DmnWq6a8.js";const A="myLibrary",D=new Set;let w=!1;function S(){const r=new Error("Login required");return r.code="auth/login-required",r}function b(){try{const r=localStorage.getItem(A),e=r?JSON.parse(r):[];return Array.isArray(e)?e.map(Number).filter(Number.isFinite):[]}catch{return[]}}function h(r){try{const e=Array.from(new Set(r.map(Number).filter(Number.isFinite)));localStorage.setItem(A,JSON.stringify(e))}catch{}}function R(r){const e=typeof r?.code=="string"?r.code:"";return e==="permission-denied"||e==="unauthenticated"||e==="unavailable"||e==="failed-precondition"||e.endsWith("/permission-denied")||e.endsWith("/unauthenticated")||e.endsWith("/unavailable")||e.endsWith("/failed-precondition")}function N(r){return typeof r=="string"&&D.has(r)}function p(r,e){if(typeof r=="string"&&r&&D.add(r),!w){const L=typeof e?.code=="string"?e.code:"unknown";console.warn(`[useLibrary] Firestore disabled (${L}). Falling back to localStorage.`),w=!0}}function T(){const[r,e]=c.useState([]),[L,y]=c.useState(!0),l=c.useRef(!1),E=c.useRef(null),v=c.useRef(null),I=c.useRef(null),M=c.useRef(null),F=c.useRef(null),m=async()=>(F.current||(F.current=Promise.all([U(),q(),x(),k()]).then(([t,i,u,n])=>(E.current=t,v.current=i,I.current=u,M.current=n,{auth:t,authModule:i,db:u,firestoreModule:n}))),F.current),g=async()=>{y(!0);try{const{auth:t,db:i,firestoreModule:u}=await m(),n=t.currentUser;if(!n){e([]),y(!1);return}if(N(n.uid)&&(l.current=!0),l.current)e(b());else{const o=u.doc(i,"users",n.uid);try{const s=await u.getDoc(o);if(s.exists()){const d=s.data().library||[],a=Array.isArray(d)?d.map(Number).filter(Number.isFinite):[];e(a),h(a)}else e([]),h([])}catch(s){R(s)?(l.current=!0,p(n.uid,s)):console.error("[useLibrary] Firestore load failed:",s),e(b())}}}catch(t){console.error("[useLibrary] Firebase init failed:",t),e(b())}y(!1)};return c.useEffect(()=>{let t=!0,i=()=>{};return(async()=>{try{const{auth:n,authModule:o}=await m();if(!t)return;await g(),i=o.onAuthStateChanged(n,s=>{l.current=N(s?.uid||""),g()})}catch(n){console.error("[useLibrary] Auth observer setup failed:",n),t&&(e(b()),y(!1))}})(),()=>{t=!1,i()}},[]),{library:r,loading:L,addToLibrary:async t=>{const i=Number(t);if(!Number.isFinite(i))return;const{auth:u,db:n,firestoreModule:o}=await m(),s=u.currentUser;if(!s)throw S();const d=b();if(!d.includes(i)){const a=[...d,i];h(a),e(a)}if(!l.current){const a=o.doc(n,"users",s.uid);try{await o.setDoc(a,{library:o.arrayUnion(i)},{merge:!0})}catch(f){R(f)?(l.current=!0,p(s.uid,f)):console.error("[useLibrary] Firestore add sync failed:",f)}}},removeFromLibrary:async t=>{const i=Number(t);if(!Number.isFinite(i))return;const{auth:u,db:n,firestoreModule:o}=await m(),s=u.currentUser;if(!s)throw S();const d=b().filter(a=>a!==i);if(h(d),e(d),!l.current){const a=o.doc(n,"users",s.uid);try{await o.setDoc(a,{library:o.arrayRemove(i)},{merge:!0})}catch(f){R(f)?(l.current=!0,p(s.uid,f)):console.error("[useLibrary] Firestore remove sync failed:",f)}}},isInLibrary:t=>r.includes(Number(t)),refreshLibrary:g}}export{T as u};
